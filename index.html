<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>프로세카 실시간 랭킹</title>
<style>
    body {
        font-family: 'Segoe UI', sans-serif;
        background: #121212;
        color: #ffffff;
        margin: 0;
        padding: 20px;
    }
    h1 {
        color: #4CAF50;
        text-align: center;
    }
    .countdown, #lastUpdate {
        text-align: center;
        font-size: 1.1em;
        margin: 5px 0;
    }
    table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 15px;
    }
    th, td {
        border: 1px solid #333;
        padding: 8px;
        text-align: center;
    }
    th {
        background: #1f1f1f;
    }
    tr:nth-child(even) {
        background: #1a1a1a;
    }
    tr.highlight {
        background: #2e7d32 !important;
    }
    img.card {
        height: 50px;
        border-radius: 5px;
    }
    @media (max-width: 600px) {
        th, td {
            font-size: 0.8em;
            padding: 4px;
        }
        img.card {
            height: 35px;
        }
    }
</style>
</head>
<body>

<h1>프로세카 실시간 랭킹</h1>
<div class="countdown" id="countdown">남은 시간 계산 중...</div>
<p id="lastUpdate">마지막 업데이트: -</p>

<table>
    <thead>
        <tr>
            <th>순위</th>
            <th>닉네임</th>
            <th>카드</th>
            <th>점수</th>
            <th>평균 속도(/h)</th>
            <th>예측 점수</th>
        </tr>
    </thead>
    <tbody id="rankingTable"></tbody>
</table>

<script>
let eventEnd = null;
let lastScores = {};
let lastFetchTime = null;
const targetRanks = [1, 5, 50, 100, 150, 200, 250, 300, 500];

async function fetchEventInfo() {
    const res = await fetch("https://api.sekai.best/master/events?region=jp");
    const json = await res.json();
    if (!json.data) return;
    const ongoing = json.data.find(e => Date.now() >= new Date(e.startAt) && Date.now() <= new Date(e.aggregateAt));
    if (ongoing) {
        eventEnd = new Date(ongoing.aggregateAt);
    }
}

function updateCountdown() {
    if (!eventEnd) return;
    const now = new Date();
    let diff = Math.max(0, eventEnd - now);
    const days = Math.floor(diff / (1000*60*60*24));
    diff %= (1000*60*60*24);
    const hours = Math.floor(diff / (1000*60*60));
    diff %= (1000*60*60);
    const minutes = Math.floor(diff / (1000*60));
    const seconds = Math.floor((diff % (1000*60)) / 1000);
    document.getElementById("countdown").innerText =
        `남은 시간: ${days}일 ${hours}시간 ${minutes}분 ${seconds}초`;
}

async function fetchRanking() {
    try {
        const res = await fetch("https://api.sekai.best/event/live?region=jp");
        const json = await res.json();
        if (!json.data || !json.data.eventRankings) {
            document.getElementById("rankingTable").innerHTML =
                `<tr><td colspan="6">데이터 없음</td></tr>`;
            return;
        }

        const now = new Date();
        const rankings = json.data.eventRankings.filter(row => targetRanks.includes(row.rank));
        let html = "";
        rankings.forEach(row => {
            let avgSpeed = "N/A";
            let prediction = "N/A";

            if (lastScores[row.rank] && lastFetchTime) {
                const diffHours = (now - lastFetchTime) / 3600000;
                avgSpeed = Math.round((row.score - lastScores[row.rank]) / diffHours);
                if (eventEnd) {
                    const hoursLeft = (eventEnd - now) / 3600000;
                    prediction = Math.round(row.score + avgSpeed * hoursLeft);
                }
            }

            lastScores[row.rank] = row.score;
            const cardUrl = `https://sekai-res.dnaroma.eu/file/sekai-assets/card/${row.userCard.cardId}_rip/card_normal.png`;

            html += `
                <tr class="${row.rank === 1 ? 'highlight' : ''}">
                    <td>${row.rank}</td>
                    <td>${row.userName}</td>
                    <td><img class="card" src="${cardUrl}" alt="Card"></td>
                    <td>${row.score.toLocaleString()}</td>
                    <td>${avgSpeed === "N/A" ? "N/A" : avgSpeed.toLocaleString()}</td>
                    <td>${prediction === "N/A" ? "N/A" : prediction.toLocaleString()}</td>
                </tr>
            `;
        });
        document.getElementById("rankingTable").innerHTML = html;
        document.getElementById("lastUpdate").innerText =
            "마지막 업데이트: " + now.toLocaleString();
        lastFetchTime = now;
    } catch (e) {
        console.error(e);
        document.getElementById("rankingTable").innerHTML =
            `<tr><td colspan="6">API 오류</td></tr>`;
    }
}

// 실행
fetchEventInfo().then(() => {
    fetchRanking();
    setInterval(fetchRanking, 300000); // 5분마다 갱신
    setInterval(updateCountdown, 1000); // 1초마다 카운트다운
});
</script>

</body>
</html>
